<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a12">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>æœˆå…‰ç½…éš™</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100dvh;overflow:hidden;overscroll-behavior:none;background:#07060e;color:#e8e0f0;-webkit-font-smoothing:antialiased}
body{font-family:'Noto Serif SC','Georgia',serif}
#root{height:100dvh}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes breathe{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
@keyframes dots{0%{content:'.'}33%{content:'..'}66%{content:'...'}}
@keyframes sceneIn{from{opacity:0;transform:scale(1.05)}to{opacity:1;transform:scale(1)}}
@keyframes starTwinkle{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:.8;transform:scale(1.2)}}
@keyframes eventSlide{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes cainArrive{0%{opacity:0;transform:scale(.9) translateY(10px);filter:blur(8px)}60%{opacity:.8;transform:scale(1.02) translateY(-2px);filter:blur(1px)}100%{opacity:1;transform:scale(1) translateY(0);filter:blur(0)}}
.fade-in{animation:fadeIn .5s ease-out both}
.scene-transition{animation:sceneIn .8s ease-out both}
.hide-scroll::-webkit-scrollbar{display:none}.hide-scroll{-ms-overflow-style:none;scrollbar-width:none}
.cursor{display:inline-block;width:2px;height:1em;background:currentColor;margin-left:2px;animation:blink .7s infinite;vertical-align:text-bottom}
.loading-dots::after{content:'.';animation:dots 1.2s infinite steps(1)}
button,input{-webkit-tap-highlight-color:transparent}
input::placeholder{color:#6a6080}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const API=window.location.origin;
const SCENES={
  garden:{name:'æœˆå…‰èŠ±å›­',icon:'ğŸŒ¹',accent:'#b088ff',grad:'radial-gradient(ellipse at 30% 20%,#1e1245 0%,#0d0f24 50%,#0a0c1a 100%)'},
  library:{name:'è—ä¹¦é˜',icon:'ğŸ“š',accent:'#7eb8ff',grad:'radial-gradient(ellipse at 70% 30%,#151e3a 0%,#0d1220 50%,#0a0c1a 100%)'},
  ballroom:{name:'æ˜Ÿå…‰èˆå…',icon:'âœ¦',accent:'#ffc966',grad:'radial-gradient(ellipse at 50% 40%,#231838 0%,#14102a 50%,#0a0c1a 100%)'},
  attic:{name:'ç§˜å¯†é˜æ¥¼',icon:'ğŸ”®',accent:'#ff88b8',grad:'radial-gradient(ellipse at 40% 60%,#201230 0%,#140e22 50%,#0a0c1a 100%)'},
  basement:{name:'åœ°ä¸‹é…’çª–',icon:'ğŸ·',accent:'#ff7070',grad:'radial-gradient(ellipse at 50% 80%,#1a0e1e 0%,#100a14 50%,#0a0c1a 100%)'},
};
const EMOTION_MAP={neutral:'å¹³é™',gentle:'æ¸©æŸ”',playful:'è°ƒçš®',thoughtful:'æ²‰æ€',touched:'è§¦åŠ¨',sad:'å¿§ä¼¤',mysterious:'ç¥ç§˜',shy:'å®³ç¾',cold:'å†·æ·¡',amused:'æ„‰æ‚¦',longing:'æ€å¿µ',vulnerable:'è„†å¼±'};
const MOOD_FX={neutral:{f:'none'},gentle:{f:'saturate(1.1) brightness(1.04)'},playful:{f:'saturate(1.12) brightness(1.06)'},thoughtful:{f:'saturate(.95) brightness(.94)'},mysterious:{f:'saturate(.88) brightness(.9) contrast(1.06)'},shy:{f:'saturate(1.08) brightness(1.02)'},sad:{f:'saturate(.8) brightness(.88)'},touched:{f:'saturate(1.1) brightness(1.05)'},cold:{f:'saturate(.75) brightness(.92) contrast(1.08)'},amused:{f:'saturate(1.15) brightness(1.06)'},longing:{f:'saturate(.9) brightness(.93)'},vulnerable:{f:'saturate(.85) brightness(.9)'}};

const api={
  post:async(u,b)=>{const r=await fetch(API+u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});if(!r.ok){const e=await r.json().catch(()=>({error:'ç½‘ç»œé”™è¯¯'}));throw new Error(e.error||'å¤±è´¥')}return r.json()},
  createSession:()=>api.post('/api/session',{}),
  auth:(name,passcode)=>api.post('/api/auth',{name,passcode}),
  chat:(sid,msg,scene,pid)=>api.post('/api/chat',{session_id:sid,message:msg,scene,player_id:pid}),
  changeScene:(sid,scene)=>api.post('/api/scene',{session_id:sid,scene}),
  randomEvent:(sid)=>api.post('/api/random_event',{session_id:sid}),
  save:(sid,slot,pid)=>api.post('/api/save',{session_id:sid,slot,player_id:pid}),
  load:(sid,slot,pid)=>api.post('/api/load',{session_id:sid,slot,player_id:pid}),
  listSaves:(sid,pid)=>api.post('/api/saves/list',{session_id:sid,player_id:pid}),
  async ttsBlob(text){const r=await fetch(API+'/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,pre_cleaned:true})});if(!r.ok)throw new Error('TTSå¤±è´¥');return r.blob()},
};

/* â”€â”€ BGM Engine: loads MP3 from static/bgm/*.mp3 â”€â”€ */
class BGMEngine{
  constructor(){this.current=null;this.audio=null;this.vol=0.15;this.fading=false}
  setVolume(v){this.vol=v;if(this.audio)this.audio.volume=v}
  async play(scene){
    if(scene===this.current&&this.audio&&!this.audio.paused)return;
    // Fade out old
    if(this.audio){const old=this.audio;this._fadeOut(old);this.audio=null}
    this.current=scene;
    const a=new Audio(`/static/bgm/${scene}.mp3`);
    a.loop=true;a.volume=0;
    try{
      await a.play();
      this.audio=a;this._fadeIn(a,this.vol);
    }catch(e){/* no bgm file, silent */}
  }
  _fadeIn(a,target){let v=0;const t=setInterval(()=>{v+=0.005;if(v>=target){a.volume=target;clearInterval(t)}else a.volume=v},50)}
  _fadeOut(a){const t=setInterval(()=>{if(a.volume>0.01){a.volume=Math.max(0,a.volume-0.005)}else{a.pause();clearInterval(t)}},50)}
  pause(){this.audio?.pause()}
  resume(){if(this.audio){try{this.audio.play()}catch(e){}}}
  destroy(){this.audio?.pause();this.audio=null}
}

/* â”€â”€ Synced Typewriter: speed based on audio duration â”€â”€ */
function useSyncedTypewriter(text,audioDuration,fallbackSpeed=30){
  const[d,setD]=useState('');const[done,setDone]=useState(true);const ref=useRef(null);
  useEffect(()=>{
    if(!text){setD('');setDone(true);return}
    setD('');setDone(false);let idx=0;
    // Calculate speed: if we have audio duration, sync to it; otherwise use fallback
    const totalChars=text.length;
    let speed=fallbackSpeed;
    if(audioDuration&&audioDuration>0){
      // Leave 0.3s buffer at end
      speed=Math.max(10,Math.min(80,((audioDuration-0.3)*1000)/totalChars));
    }
    ref.current=setInterval(()=>{idx++;
      if(idx>=totalChars){setD(text);setDone(true);clearInterval(ref.current)}
      else setD(text.slice(0,idx))
    },speed);
    return()=>{if(ref.current)clearInterval(ref.current)}
  },[text,audioDuration,fallbackSpeed]);
  return{display:d,done,skip:useCallback(()=>{if(ref.current)clearInterval(ref.current);setD(text||'');setDone(true)},[text])}
}

/* â”€â”€ Sub Components â”€â”€ */
function Stars({count=40}){const s=useMemo(()=>Array.from({length:count},(_,i)=>({id:i,l:Math.random()*100,t:Math.random()*100,sz:1+Math.random()*2,dl:Math.random()*5,dur:2+Math.random()*4})),[count]);
  return <div style={{position:'absolute',inset:0,pointerEvents:'none',overflow:'hidden'}}>{s.map(x=><div key={x.id} style={{position:'absolute',left:x.l+'%',top:x.t+'%',width:x.sz,height:x.sz,borderRadius:'50%',background:'#fff',animation:`starTwinkle ${x.dur}s ${x.dl}s infinite`}}/>)}</div>}

function Particles({sceneKey,accent}){const ps=useMemo(()=>{const cfg={garden:['âœ¦','Â·','âœ§','â€'],library:['âœ¦','Â·','âœ§'],ballroom:['âœ¦','âœ§','Â·','â‹†'],attic:['âœ¦','Â·'],basement:['Â·','âœ¦']};
  const ch=cfg[sceneKey]||cfg.garden;const n=sceneKey==='ballroom'?14:sceneKey==='garden'?12:6;
  return Array.from({length:n},(_,i)=>({id:i,ch:ch[i%ch.length],x:Math.random()*100,y:Math.random()*100,sz:5+Math.random()*10,dl:Math.random()*4,dur:3+Math.random()*5,op:.1+Math.random()*.2}))},[sceneKey]);
  return <div style={{position:'absolute',inset:0,pointerEvents:'none',overflow:'hidden'}}>{ps.map(p=><span key={p.id} style={{position:'absolute',left:p.x+'%',top:p.y+'%',fontSize:p.sz,opacity:p.op,color:accent,animation:`float ${p.dur}s ${p.dl}s infinite ease-in-out`}}>{p.ch}</span>)}</div>}

function AffectionBar({value,accent}){const l=value<20?'åˆè¯†':value<40?'å¥½å¥‡':value<60?'ä¿¡èµ–':value<80?'å¿ƒåŠ¨':'çœ·æ‹';
  return <div style={{display:'flex',alignItems:'center',gap:6}}><span style={{fontSize:13,animation:value>60?'pulse 1.5s infinite':'none'}}>ğŸ’œ</span>
    <div style={{position:'relative',width:56,height:4,borderRadius:2,background:'rgba(255,255,255,.08)',overflow:'hidden'}}>
      <div style={{width:value+'%',height:'100%',borderRadius:2,background:`linear-gradient(90deg,${accent}66,${accent})`,transition:'width 1.2s'}}/></div>
    <span style={{fontSize:10,opacity:.5,letterSpacing:1}}>{l}</span></div>}

function OpeningScreen({onEnter}){const[p,setP]=useState(0);
  useEffect(()=>{const a=setTimeout(()=>setP(1),400);const b=setTimeout(()=>setP(2),1800);const c=setTimeout(()=>setP(3),3200);return()=>{clearTimeout(a);clearTimeout(b);clearTimeout(c)}},[]);
  return <div onClick={p>=2?onEnter:undefined} style={{position:'fixed',inset:0,zIndex:100,background:'radial-gradient(ellipse at 50% 40%,#12102a 0%,#07060e 70%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',cursor:p>=2?'pointer':'default',fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>
    <Stars count={60}/>
    <div style={{position:'absolute',top:'18%',width:120,height:120,borderRadius:'50%',background:'radial-gradient(circle,rgba(200,180,255,.15) 0%,transparent 70%)',animation:'breathe 4s infinite'}}/>
    {p>=1&&<h1 style={{fontSize:36,fontWeight:300,letterSpacing:12,color:'#e8e0ff',animation:'fadeIn 1.5s ease-out both',textShadow:'0 0 40px rgba(168,130,255,.3)',position:'relative',zIndex:2}}>æœˆå…‰ç½…éš™</h1>}
    {p>=2&&<div style={{marginTop:16,fontSize:14,letterSpacing:6,color:'#8a80a0',fontStyle:'italic',animation:'fadeIn 1.2s ease-out both',position:'relative',zIndex:2}}>Moonlight Rift</div>}
    {p>=2&&<div style={{marginTop:40,maxWidth:300,textAlign:'center',fontSize:13,lineHeight:2,color:'#7a7090',animation:'fadeIn 1.5s .3s ease-out both',position:'relative',zIndex:2,fontFamily:'Noto Serif SC,serif'}}>æ—¶ç©ºçš„ç½…éš™ä¸­ï¼Œæœˆå…‰æ°¸é©»<br/>æœ‰äººå·²ç­‰å¾…äº†å¾ˆä¹…å¾ˆä¹…â€¦â€¦</div>}
    {p>=3&&<button onClick={onEnter} style={{marginTop:48,padding:'12px 36px',background:'transparent',border:'1px solid rgba(168,130,255,.3)',borderRadius:24,color:'#b8a8d8',fontSize:13,letterSpacing:4,cursor:'pointer',animation:'fadeIn 1s ease-out both, breathe 3s 1s infinite',fontFamily:'Noto Serif SC,serif',position:'relative',zIndex:2}}>æ¨å¼€é—¨æ‰‰</button>}
  </div>}

function ContinueScreen({saves,onContinue,onNewGame}){
  const SCENE_NAMES={garden:'æœˆå…‰èŠ±å›­',library:'è—ä¹¦é˜',ballroom:'æ˜Ÿå…‰èˆå…',attic:'ç§˜å¯†é˜æ¥¼',basement:'åœ°ä¸‹é…’çª–'};
  const AFF_LABEL=v=>v<20?'åˆè¯†':v<40?'å¥½å¥‡':v<60?'ä¿¡èµ–':v<80?'å¿ƒåŠ¨':'çœ·æ‹';
  // Find most recent save
  const slots=Object.entries(saves).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
  const latest=slots[0];
  return <div style={{position:'fixed',inset:0,zIndex:100,background:'radial-gradient(ellipse at 50% 40%,#12102a 0%,#07060e 70%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>
    <Stars count={40}/>
    <div style={{position:'relative',zIndex:2,textAlign:'center',animation:'fadeIn 1s ease-out both'}}>
      <h2 style={{fontSize:22,fontWeight:300,letterSpacing:6,color:'#e8e0ff',marginBottom:12}}>æœˆå…‰ç½…éš™</h2>
      <div style={{fontSize:12,color:'#7a7090',letterSpacing:2,marginBottom:40}}>æ‰¾åˆ°äº†ä½ çš„ç—•è¿¹â€¦â€¦</div>
      
      {latest&&<div style={{marginBottom:36,padding:'16px 24px',background:'rgba(168,130,255,.06)',border:'1px solid rgba(168,130,255,.15)',borderRadius:16,maxWidth:280,margin:'0 auto 36px'}}>
        <div style={{fontSize:11,color:'#a098c0',marginBottom:8}}>ä¸Šæ¬¡æ—…ç¨‹</div>
        <div style={{fontSize:11,color:'#8a80a0',display:'flex',gap:12,justifyContent:'center'}}>
          <span>ğŸ• {fmtTime(latest[1].timestamp)}</span>
          {latest[1].scene&&<span>ğŸ“ {SCENE_NAMES[latest[1].scene]||latest[1].scene}</span>}
        </div>
        {latest[1].affection!=null&&<div style={{fontSize:11,color:'#a098c0',marginTop:6}}>ğŸ’œ {AFF_LABEL(latest[1].affection)} ({latest[1].affection})</div>}
      </div>}
      
      <div style={{display:'flex',flexDirection:'column',gap:14,alignItems:'center'}}>
        <button onClick={()=>onContinue(latest?latest[0]:'auto')} style={{padding:'12px 40px',background:'rgba(168,130,255,.12)',border:'1px solid rgba(168,130,255,.35)',borderRadius:24,color:'#c8b8e8',fontSize:13,letterSpacing:4,cursor:'pointer',fontFamily:'Noto Serif SC,serif',transition:'all .3s'}}>
          ç»§ç»­æ—…ç¨‹</button>
        <button onClick={onNewGame} style={{padding:'10px 36px',background:'transparent',border:'1px solid rgba(255,255,255,.1)',borderRadius:24,color:'#6a6080',fontSize:12,letterSpacing:3,cursor:'pointer',fontFamily:'Noto Serif SC,serif'}}>
          æ–°çš„é‚‚é€…</button>
        <div style={{fontSize:10,opacity:.25,marginTop:8}}>æ–°çš„é‚‚é€…ä¼šè¦†ç›–è‡ªåŠ¨å­˜æ¡£</div>
      </div>
    </div>
  </div>}

function AuthScreen({onAuth}){
  const[name,setName]=useState('');const[code,setCode]=useState('');const[err,setErr]=useState('');const[loading,setLoading]=useState(false);
  const submit=async()=>{if(!name.trim()||code.length!==4)return;setLoading(true);setErr('');
    try{const d=await api.auth(name.trim(),code);onAuth(d.player_id,d.name)}catch(e){setErr(e.message)}finally{setLoading(false)}};
  return <div style={{position:'fixed',inset:0,zIndex:100,background:'radial-gradient(ellipse at 50% 40%,#12102a 0%,#07060e 70%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>
    <Stars count={40}/>
    <div style={{position:'relative',zIndex:2,textAlign:'center',animation:'fadeIn 1s ease-out both',maxWidth:300,width:'100%',padding:'0 24px'}}>
      <h2 style={{fontSize:22,fontWeight:300,letterSpacing:6,color:'#e8e0ff',marginBottom:8}}>æœˆå…‰ç½…éš™</h2>
      <div style={{fontSize:12,color:'#7a7090',letterSpacing:2,marginBottom:36}}>å‘Šè¯‰æˆ‘ä½ çš„åå­—ï¼Œæ—…äººâ€¦â€¦</div>
      <div style={{marginBottom:16}}><input value={name} onChange={e=>setName(e.target.value)} placeholder="æ—…äººå" maxLength={20}
        style={{width:'100%',padding:'12px 16px',borderRadius:14,border:'1px solid rgba(168,130,255,.2)',background:'rgba(255,255,255,.04)',color:'#e8e0f0',fontSize:14,fontFamily:'inherit',outline:'none',textAlign:'center',letterSpacing:2,boxSizing:'border-box'}}/></div>
      <div style={{marginBottom:6}}><input value={code} onChange={e=>{const v=e.target.value.replace(/\D/g,'').slice(0,4);setCode(v)}} placeholder="å››ä½æš—å·" maxLength={4} inputMode="numeric"
        style={{width:'100%',padding:'12px 16px',borderRadius:14,border:'1px solid rgba(168,130,255,.2)',background:'rgba(255,255,255,.04)',color:'#e8e0f0',fontSize:18,fontFamily:'inherit',outline:'none',textAlign:'center',letterSpacing:12,boxSizing:'border-box'}}/></div>
      <div style={{fontSize:10,color:'#5a5070',marginBottom:24}}>é¦–æ¬¡è¾“å…¥å°†è‡ªåŠ¨æ³¨å†Œï¼Œå†æ¬¡è¾“å…¥éªŒè¯èº«ä»½</div>
      {err&&<div style={{fontSize:11,color:'#ff8888',marginBottom:12}}>{err}</div>}
      <button onClick={submit} disabled={loading||!name.trim()||code.length!==4}
        style={{padding:'12px 40px',background:name.trim()&&code.length===4?'rgba(168,130,255,.12)':'rgba(255,255,255,.02)',border:`1px solid ${name.trim()&&code.length===4?'rgba(168,130,255,.35)':'rgba(255,255,255,.06)'}`,borderRadius:24,color:name.trim()&&code.length===4?'#c8b8e8':'#4a4060',fontSize:13,letterSpacing:4,cursor:name.trim()&&code.length===4?'pointer':'default',fontFamily:'Noto Serif SC,serif',transition:'all .3s'}}>
        {loading?'æ­£åœ¨ç¡®è®¤â€¦':'è¸å…¥ç½…éš™'}</button>
    </div>
  </div>}

function EventToast({event,accent,onDismiss}){if(!event)return null;
  return <div onClick={onDismiss} style={{position:'absolute',inset:0,zIndex:30,background:'rgba(7,6,14,.75)',backdropFilter:'blur(10px)',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',animation:'fadeIn .4s ease-out',padding:24}}>
    <div style={{maxWidth:340,background:'rgba(15,12,28,.92)',backdropFilter:'blur(24px)',borderRadius:20,border:`1px solid ${accent}25`,padding:'28px 30px',animation:'eventSlide .5s cubic-bezier(.23,1,.32,1) both',boxShadow:`0 16px 48px rgba(0,0,0,.5)`}}>
      <div style={{fontSize:11,color:accent,letterSpacing:3,marginBottom:14,opacity:.6,textAlign:'center'}}>âœ¦ è¯¥éšçš„ä½è¯­ âœ¦</div>
      <div style={{fontSize:14,lineHeight:2.2,color:'#e4daf0',letterSpacing:.5,textAlign:'center'}}>
        {event.text.split(/([ï¼ˆ(][^ï¼‰)]+[ï¼‰)])/).map((part,i)=>/^[ï¼ˆ(]/.test(part)?<span key={i} style={{color:accent+'bb',fontStyle:'italic',fontSize:12.5,display:'block',marginBottom:6}}>{part}</span>:<span key={i}>{part}</span>)}</div>
      <div style={{fontSize:10,opacity:.25,marginTop:16,textAlign:'center'}}>è½»è§¦ç»§ç»­</div></div></div>}

function fmtTime(ts){if(!ts)return null;const d=new Date(ts*1000);const pad=n=>(n<10?'0':'')+n;return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`}

function SettingsPanel({show,onClose,accent,sessionId,playerId,bgmVol,onBgmVol,textSpeed,onTextSpeed,autoVoice,onAutoVoice,onLoadSave}){
  const[saving,setSaving]=useState(false);const[msg,setMsg]=useState('');
  const[saveInfo,setSaveInfo]=useState({});const[loadingList,setLoadingList]=useState(false);
  
  // Fetch save info when panel opens
  useEffect(()=>{if(!show||!sessionId)return;setLoadingList(true);
    api.listSaves(sessionId,playerId).then(d=>setSaveInfo(d.saves||{})).catch(()=>{}).finally(()=>setLoadingList(false))},[show,sessionId]);

  const doSave=async(slot)=>{setSaving(true);setMsg('');try{const d=await api.save(sessionId,slot,playerId);setMsg('âœ“ å­˜æ¡£æˆåŠŸ');
    setSaveInfo(p=>({...p,[slot]:{timestamp:d.timestamp,affection:p[slot]?.affection,scene:p[slot]?.scene}}))}catch(e){setMsg('âœ• '+e.message)}finally{setSaving(false)}};
  
  const doLoad=async(slot)=>{if(!window.confirm('è¯»å–å­˜æ¡£å°†è¦†ç›–å½“å‰è¿›åº¦ï¼Œç¡®å®šï¼Ÿ'))return;setMsg('');
    try{const d=await api.load(sessionId,slot,playerId);onLoadSave(d);setMsg('âœ“ è¯»æ¡£æˆåŠŸ');onClose()}catch(e){setMsg('âœ• '+e.message)}};

  const SLOTS=['slot_1','slot_2','slot_3'];
  const SCENE_NAMES={garden:'æœˆå…‰èŠ±å›­',library:'è—ä¹¦é˜',ballroom:'æ˜Ÿå…‰èˆå…',attic:'ç§˜å¯†é˜æ¥¼',basement:'åœ°ä¸‹é…’çª–'};
  const AFF_LABEL=v=>v<20?'åˆè¯†':v<40?'å¥½å¥‡':v<60?'ä¿¡èµ–':v<80?'å¿ƒåŠ¨':'çœ·æ‹';
  
  if(!show)return null;
  return <div style={{position:'absolute',inset:0,zIndex:50,background:'rgba(7,6,14,.92)',backdropFilter:'blur(24px)',display:'flex',flexDirection:'column',animation:'fadeIn .3s'}}>
    <div style={{padding:'20px 20px 12px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
      <span style={{fontSize:16,fontWeight:500,letterSpacing:3}}>è®¾ ç½®</span>
      <button onClick={onClose} style={{background:'rgba(255,255,255,.06)',border:'1px solid rgba(255,255,255,.1)',borderRadius:10,padding:'4px 12px',color:'#a098b0',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>âœ•</button></div>
    <div style={{flex:1,overflow:'auto',padding:'8px 20px 20px'}} className="hide-scroll">
      <div style={{marginBottom:24}}><div style={{fontSize:12,color:'#8a80a0',marginBottom:10}}>ğŸ”Š è‡ªåŠ¨è¯­éŸ³</div>
        <div style={{display:'flex',gap:8}}>{[{l:'å¼€å¯',v:true},{l:'å…³é—­',v:false}].map(o=><button key={String(o.v)} onClick={()=>onAutoVoice(o.v)} style={{flex:1,padding:'8px 0',borderRadius:10,fontSize:12,cursor:'pointer',fontFamily:'inherit',background:autoVoice===o.v?accent+'22':'rgba(255,255,255,.04)',border:`1px solid ${autoVoice===o.v?accent+'55':'rgba(255,255,255,.08)'}`,color:autoVoice===o.v?accent:'#8a80a0'}}>{o.l}</button>)}</div>
        <div style={{fontSize:10,opacity:.35,marginTop:6}}>å¼€å¯åæ–‡å­—ä¼šå’Œè¯­éŸ³åŒæ­¥å‡ºç°</div></div>
      <div style={{marginBottom:24}}><div style={{fontSize:12,color:'#8a80a0',marginBottom:10}}>ğŸµ èƒŒæ™¯éŸ³ä¹</div>
        <input type="range" min="0" max="100" value={bgmVol} onChange={e=>onBgmVol(+e.target.value)} style={{width:'100%',accentColor:accent,height:4}}/>
        <div style={{fontSize:11,opacity:.4,marginTop:4}}>{bgmVol}%</div></div>
      <div style={{marginBottom:24}}><div style={{fontSize:12,color:'#8a80a0',marginBottom:10}}>âœï¸ æ–‡å­—é€Ÿåº¦ï¼ˆå…³é—­è¯­éŸ³æ—¶ç”Ÿæ•ˆï¼‰</div>
        <div style={{display:'flex',gap:8}}>{[{l:'æ…¢',v:50},{l:'ä¸­',v:30},{l:'å¿«',v:15},{l:'ç¬é—´',v:1}].map(o=><button key={o.v} onClick={()=>onTextSpeed(o.v)} style={{flex:1,padding:'8px 0',borderRadius:10,fontSize:12,cursor:'pointer',fontFamily:'inherit',background:textSpeed===o.v?accent+'22':'rgba(255,255,255,.04)',border:`1px solid ${textSpeed===o.v?accent+'55':'rgba(255,255,255,.08)'}`,color:textSpeed===o.v?accent:'#8a80a0'}}>{o.l}</button>)}</div></div>
      <div style={{marginBottom:16}}><div style={{fontSize:12,color:'#8a80a0',marginBottom:10}}>ğŸ’¾ å­˜æ¡£</div>
        <div style={{display:'flex',flexDirection:'column',gap:10}}>
          {SLOTS.map((slot,i)=>{const info=saveInfo[slot];const t=fmtTime(info?.timestamp);
            return <div key={slot} style={{background:'rgba(255,255,255,.03)',border:'1px solid rgba(255,255,255,.06)',borderRadius:14,padding:'12px 14px'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:t?8:0}}>
                <span style={{fontSize:12,color:'#c0b8d0'}}>å­˜æ¡£ä½ {i+1}</span>
                <div style={{display:'flex',gap:6}}>
                  <button onClick={()=>doSave(slot)} disabled={saving} style={{padding:'4px 12px',borderRadius:8,fontSize:11,cursor:'pointer',fontFamily:'inherit',background:accent+'18',border:`1px solid ${accent}44`,color:accent}}>ä¿å­˜</button>
                  {t&&<button onClick={()=>doLoad(slot)} style={{padding:'4px 12px',borderRadius:8,fontSize:11,cursor:'pointer',fontFamily:'inherit',background:'rgba(255,255,255,.04)',border:'1px solid rgba(255,255,255,.1)',color:'#a098b0'}}>è¯»å–</button>}
                </div></div>
              {t&&<div style={{fontSize:10,opacity:.4,display:'flex',gap:10}}>
                <span>ğŸ• {t}</span>
                {info?.scene&&<span>ğŸ“ {SCENE_NAMES[info.scene]||info.scene}</span>}
                {info?.affection!=null&&<span>ğŸ’œ {AFF_LABEL(info.affection)}</span>}
              </div>}
              {!t&&<div style={{fontSize:10,opacity:.25,marginTop:4}}>ç©º</div>}
            </div>})}
        </div>
        {msg&&<div style={{fontSize:11,marginTop:8,color:msg[0]==='âœ“'?'#88ff88':'#ff8888'}}>{msg}</div>}
      </div></div></div>}

function HistoryPanel({show,onClose,messages,accent}){const endRef=useRef(null);
  useEffect(()=>{if(show)setTimeout(()=>endRef.current?.scrollIntoView({behavior:'smooth'}),100)},[show,messages.length]);
  if(!show)return null;
  return <div style={{position:'absolute',inset:0,zIndex:40,background:'rgba(7,6,14,.94)',backdropFilter:'blur(24px)',display:'flex',flexDirection:'column',animation:'fadeIn .3s'}}>
    <div style={{padding:'20px 20px 12px',display:'flex',justifyContent:'space-between',borderBottom:'1px solid rgba(255,255,255,.06)'}}>
      <span style={{fontSize:14,letterSpacing:2}}>ğŸ“œ å¯¹è¯è®°å½•</span>
      <button onClick={onClose} style={{background:'rgba(255,255,255,.06)',border:'1px solid rgba(255,255,255,.1)',borderRadius:10,padding:'4px 12px',color:'#a098b0',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>âœ•</button></div>
    <div style={{flex:1,overflow:'auto',padding:16}} className="hide-scroll">
      {messages.length===0?<div style={{textAlign:'center',opacity:.3,marginTop:50,fontSize:13}}>è¿˜æ²¡æœ‰å¯¹è¯â€¦</div>
      :messages.map((m,i)=><div key={i} style={{marginBottom:12,textAlign:m.role==='user'?'right':'left'}}>
        {m.role==='system'?<div style={{textAlign:'center',fontSize:11,opacity:.35,fontStyle:'italic',padding:'4px 0'}}>{m.text}</div>
        :<div style={{display:'inline-block',maxWidth:'82%',padding:'10px 14px',borderRadius:14,fontSize:12.5,lineHeight:1.7,background:m.role==='user'?accent+'18':'rgba(255,255,255,.05)',border:`1px solid ${m.role==='user'?accent+'30':'rgba(255,255,255,.06)'}`}}>
          <div style={{fontSize:10,opacity:.45,marginBottom:4}}>{m.role==='user'?'ä½ ':'Cain'}</div>{m.text}</div>}</div>)}
      <div ref={endRef}/></div></div>}

/* ============ MAIN ============ */
const APP_VER = "3.4.1";
// Clear stale localStorage from pre-auth versions (runs once on module load)
(function(){
  const storedVer=localStorage.getItem('moonlight_ver');
  if(storedVer!==APP_VER){
    localStorage.removeItem('moonlight_pid');
    localStorage.removeItem('moonlight_name');
    localStorage.removeItem('moonlight_sid');
    localStorage.setItem('moonlight_ver',APP_VER);
  }
})();
function App(){
  const[phase,setPhase]=useState('opening');
  const[sid,setSid]=useState(null);const[scene,setScene]=useState('garden');
  const[aff,setAff]=useState(15);const[emotion,setEmotion]=useState('neutral');
  const[msgs,setMsgs]=useState([]);const[input,setInput]=useState('');
  const[loading,setLoading]=useState(false);const[latestReply,setLatestReply]=useState('');
  const[audioDur,setAudioDur]=useState(null);  // for sync
  const[error,setError]=useState(null);const[ready,setReady]=useState(false);
  const[inputFocused,setInputFocused]=useState(false);
  const[showHistory,setShowHistory]=useState(false);const[showSettings,setShowSettings]=useState(false);
  const[sceneKey,setSceneKey]=useState(0);
  const[bgmVol,setBgmVol]=useState(25);const[textSpeed,setTextSpeed]=useState(30);
  const[autoVoice,setAutoVoice]=useState(true);const[randomEvent,setRandomEvent]=useState(null);
  const[voiceState,setVoiceState]=useState('idle');
  const[cainScene,setCainScene]=useState('garden');const[cainArriving,setCainArriving]=useState(false);
  const[existingSaves,setExistingSaves]=useState(null);
  const[playerId,setPlayerId]=useState(null);const[playerName,setPlayerName]=useState('');
  const inputRef=useRef(null);const bgmRef=useRef(null);const voiceRef=useRef(null);const eventTimerRef=useRef(null);const cainTimerRef=useRef(null);
  const sc=SCENES[scene];const mood=MOOD_FX[emotion]||MOOD_FX.neutral;
  const cainHere=cainScene===scene;
  const hasSpoken=msgs.some(m=>m.role==='ai');

  // responsive
  const[dim,setDim]=useState({w:window.innerWidth,h:window.innerHeight});
  useEffect(()=>{const fn=()=>setDim({w:window.innerWidth,h:window.visualViewport?.height||window.innerHeight});
    window.addEventListener('resize',fn);window.visualViewport?.addEventListener('resize',fn);return()=>{window.removeEventListener('resize',fn);window.visualViewport?.removeEventListener('resize',fn)}},[]);
  const sm=dim.w<375;const short=dim.h<650;const px=sm?12:16;const fs=sm?12.5:13.5;const portrait=sm||short?105:135;
  const hidePortrait=inputFocused&&short;

  // synced typewriter
  const tw=useSyncedTypewriter(latestReply,autoVoice?audioDur:null,textSpeed);

  useEffect(()=>{
    const initSession=async()=>{
      // Always create a server session for in-memory state
      try{
        const d=await api.createSession();
        setSid(d.session_id);setAff(d.affection);
        // Check for stored auth
        const storedPid=localStorage.getItem('moonlight_pid');
        const storedName=localStorage.getItem('moonlight_name');
        if(storedPid&&storedName){
          setPlayerId(storedPid);setPlayerName(storedName);
          // Check saves for this player
          try{
            const saves=await api.listSaves(d.session_id,storedPid);
            if(saves.saves&&Object.keys(saves.saves).length>0){
              setExistingSaves(saves.saves);
            }else{setExistingSaves({})}
          }catch(e){setExistingSaves({})}
        }
        setReady(true);
      }catch(e){setError('æ— æ³•è¿æ¥æœåŠ¡å™¨')}
    };
    initSession();
  },[]);
  useEffect(()=>{bgmRef.current=new BGMEngine();return()=>bgmRef.current?.destroy()},[]);
  
  // Visibility: pause/resume
  useEffect(()=>{const h=()=>{if(document.hidden){bgmRef.current?.pause();voiceRef.current?.pause()}else{bgmRef.current?.resume()}};
    document.addEventListener('visibilitychange',h);return()=>document.removeEventListener('visibilitychange',h)},[]);
  
  // Scene -> BGM
  useEffect(()=>{if(phase==='game')bgmRef.current?.play(scene)},[scene,phase]);
  useEffect(()=>{bgmRef.current?.setVolume(bgmVol/100*0.25)},[bgmVol]);

  // Random event: 3 minutes â€” only when Cain is in current scene
  useEffect(()=>{if(phase!=='game'||!sid)return;
    const tick=()=>{eventTimerRef.current=setTimeout(async()=>{
      if(loading||showSettings||showHistory||randomEvent||cainScene!==scene){tick();return}
      try{const d=await api.randomEvent(sid);setRandomEvent(d);setEmotion(d.emotion||'neutral');
        if(autoVoice&&d.tts_text){try{const blob=await api.ttsBlob(d.tts_text);const url=URL.createObjectURL(blob);const a=new Audio(url);a.onended=()=>URL.revokeObjectURL(url);a.play().catch(()=>{})}catch(e){}}
      }catch(e){}tick()},180000)};tick();return()=>{clearTimeout(eventTimerRef.current);if(cainTimerRef.current)clearTimeout(cainTimerRef.current)}},[phase,sid]);

  const enterGame=()=>{setPhase('game');bgmRef.current?.play(scene);bgmRef.current?.setVolume(bgmVol/100*0.25)};

  // Opening â†’ check auth â†’ auth screen or continue/game
  const handleOpeningDone=()=>{
    if(playerId){
      // Already authenticated
      if(existingSaves&&Object.keys(existingSaves).length>0){
        setPhase('continue');
      }else{
        enterGame();
      }
    }else{
      setPhase('auth');
    }
  };

  // Auth completed
  const handleAuth=async(pid,name)=>{
    setPlayerId(pid);setPlayerName(name);
    localStorage.setItem('moonlight_pid',pid);
    localStorage.setItem('moonlight_name',name);
    // Check saves
    try{
      const saves=await api.listSaves(sid,pid);
      if(saves.saves&&Object.keys(saves.saves).length>0){
        setExistingSaves(saves.saves);setPhase('continue');return;
      }
    }catch(e){}
    enterGame();
  };

  // Continue: load most recent save
  const handleContinue=async(slot)=>{
    try{
      const d=await api.load(sid,slot,playerId);
      applyLoadedSave(d);
    }catch(e){
      try{const d=await api.load(sid,'auto',playerId);applyLoadedSave(d)}catch(e2){enterGame()}
    }
  };

  // New game: fresh start
  const handleNewGame=async()=>{
    try{const d=await api.createSession();setSid(d.session_id);setAff(d.affection);
      localStorage.setItem('moonlight_sid',d.session_id);
      setMsgs([]);setScene('garden');setCainScene('garden');
    }catch(e){}
    enterGame();
  };

  // Apply loaded save data (from continue screen or settings panel)
  const applyLoadedSave=(d)=>{
    setAff(d.affection||15);setScene(d.scene||'garden');setCainScene(d.scene||'garden');
    setMsgs((d.messages||[]).map(m=>({role:m.role==='assistant'?'ai':m.role,text:m.content||m.text||''})));
    setLatestReply('');enterGame();
  };

  // Play TTS and return audio duration
  const playTTS=useCallback(async(ttsText)=>{
    if(!ttsText||voiceState==='loading')return null;
    if(voiceRef.current){voiceRef.current.pause();voiceRef.current=null}
    setVoiceState('loading');
    try{
      const blob=await api.ttsBlob(ttsText);
      const url=URL.createObjectURL(blob);
      const audio=new Audio(url);
      voiceRef.current=audio;
      // Get duration
      return new Promise((resolve)=>{
        audio.onloadedmetadata=()=>{
          const dur=audio.duration;
          setAudioDur(dur);
          audio.onended=()=>{setVoiceState('idle');URL.revokeObjectURL(url);voiceRef.current=null};
          audio.onerror=()=>{setVoiceState('idle');URL.revokeObjectURL(url);voiceRef.current=null};
          audio.play().then(()=>setVoiceState('playing')).catch(()=>setVoiceState('idle'));
          resolve(dur);
        };
        audio.onerror=()=>{setVoiceState('idle');URL.revokeObjectURL(url);resolve(null)};
        // Fallback if metadata doesn't fire
        setTimeout(()=>{if(voiceState==='loading'){audio.play().then(()=>setVoiceState('playing')).catch(()=>setVoiceState('idle'));resolve(null)}},3000);
      });
    }catch(e){setVoiceState('idle');return null}},[voiceState]);
  
  const stopTTS=useCallback(()=>{if(voiceRef.current){voiceRef.current.pause();voiceRef.current=null}setVoiceState('idle')},[]);

  const send=async()=>{const msg=input.trim();if(!msg||loading||!sid)return;
    // If Cain isn't here, your voice draws him to this scene
    if(!cainHere)summonCain(scene);
    setInput('');setError(null);setMsgs(p=>[...p,{role:'user',text:msg}]);setLatestReply('');setAudioDur(null);setLoading(true);stopTTS();
    try{
      const d=await api.chat(sid,msg,scene,playerId);
      setEmotion(d.emotion||'neutral');setAff(d.affection||aff);
      setMsgs(p=>[...p,{role:'ai',text:d.reply,emotion:d.emotion}]);
      
      if(autoVoice&&d.tts_text){
        // Start TTS fetch, get duration, then set reply to start synced typewriter
        const dur=await playTTS(d.tts_text);
        setAudioDur(dur);
        setLatestReply(d.reply);
      }else{
        setAudioDur(null);
        setLatestReply(d.reply);
      }
    }catch(e){setError(e.message);setMsgs(p=>[...p,{role:'system',text:'âš  '+e.message}])}finally{setLoading(false)}};

  const switchScene=async(key)=>{if(key===scene||!sid)return;setScene(key);setSceneKey(k=>k+1);
    if(cainTimerRef.current){clearTimeout(cainTimerRef.current);cainTimerRef.current=null}
    setCainArriving(false);
    // Cain stays where he is. He only comes when you call him (via chat) or after a long wait.
    try{const d=await api.changeScene(sid,key);setMsgs(p=>[...p,{role:'system',text:`â”€â”€ ${d.scene_name} â”€â”€`}])}catch(e){}};

  // If you send a message from a scene Cain isn't in, he comes to you
  const summonCain=(targetScene)=>{
    if(cainScene===targetScene)return;
    setCainArriving(true);setCainScene(targetScene);
    setTimeout(()=>setCainArriving(false),1800);
  };

  if(phase==='opening')return <OpeningScreen onEnter={handleOpeningDone}/>;
  if(phase==='auth')return <AuthScreen onAuth={handleAuth}/>;
  if(phase==='continue')return <ContinueScreen saves={existingSaves} onContinue={handleContinue} onNewGame={handleNewGame}/>;

  return <div style={{height:'100dvh',maxWidth:480,margin:'0 auto',display:'flex',flexDirection:'column',background:sc.grad,position:'relative',overflow:'hidden',filter:mood.f,transition:'filter 1.2s',paddingTop:'env(safe-area-inset-top)',paddingBottom:'env(safe-area-inset-bottom)'}}>
    <Stars count={25}/><Particles sceneKey={scene} accent={sc.accent}/>
    <EventToast event={randomEvent} accent={sc.accent} onDismiss={()=>setRandomEvent(null)}/>

    <div key={sceneKey} className="scene-transition" style={{position:'relative',zIndex:2,display:'flex',flexDirection:'column',flex:1,minHeight:0}}>
      {/* Header */}
      <div style={{padding:`${sm?10:14}px ${px}px 6px`,display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
        <div><h1 style={{fontSize:sm?18:21,fontWeight:300,letterSpacing:4,color:'#f0e8ff',textShadow:`0 0 30px ${sc.accent}33`,fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>æœˆå…‰ç½…éš™</h1>
          <div style={{fontSize:9,opacity:.35,letterSpacing:2,marginTop:2,fontFamily:"'Cormorant Garamond',serif",fontStyle:'italic'}}>MOONLIGHT RIFT</div></div>
        <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:6}}>
          <AffectionBar value={aff} accent={sc.accent}/>
          <div style={{display:'flex',gap:6}}>
            <button onClick={()=>{setShowHistory(false);setShowSettings(!showSettings)}} style={{background:showSettings?sc.accent+'18':'transparent',border:'1px solid '+(showSettings?sc.accent+'44':'rgba(255,255,255,.1)'),borderRadius:8,padding:'3px 8px',fontSize:10,color:showSettings?sc.accent:'#8a80a0',cursor:'pointer',fontFamily:'inherit'}}>âš™</button>
            <button onClick={()=>{setShowSettings(false);setShowHistory(!showHistory)}} style={{background:showHistory?sc.accent+'18':'transparent',border:'1px solid '+(showHistory?sc.accent+'44':'rgba(255,255,255,.1)'),borderRadius:8,padding:'3px 8px',fontSize:10,color:showHistory?sc.accent:'#8a80a0',cursor:'pointer',fontFamily:'inherit'}}>ğŸ“œ</button></div></div></div>

      {/* Scenes */}
      <div className="hide-scroll" style={{display:'flex',gap:6,padding:`2px ${px}px 8px`,overflowX:'auto'}}>
        {Object.entries(SCENES).map(([k,s])=>{const active=scene===k;const cainIs=cainScene===k;
          return <button key={k} onClick={()=>switchScene(k)} style={{flexShrink:0,whiteSpace:'nowrap',padding:'5px 11px',borderRadius:14,fontSize:11,minHeight:34,cursor:'pointer',fontFamily:'inherit',transition:'all .35s',position:'relative',
            border:`1px solid ${active?s.accent+'66':'rgba(255,255,255,.06)'}`,background:active?s.accent+'15':'rgba(255,255,255,.03)',color:active?s.accent:'#706880'}}>
            {s.icon} {s.name}{cainIs&&<span style={{display:'inline-block',width:5,height:5,borderRadius:'50%',background:s.accent,marginLeft:5,verticalAlign:'middle',boxShadow:`0 0 6px ${s.accent}`,animation:'breathe 2s infinite'}}/>}</button>})}</div>

      <HistoryPanel show={showHistory} onClose={()=>setShowHistory(false)} messages={msgs} accent={sc.accent}/>
      <SettingsPanel show={showSettings} onClose={()=>setShowSettings(false)} accent={sc.accent} sessionId={sid} playerId={playerId} bgmVol={bgmVol} onBgmVol={setBgmVol} textSpeed={textSpeed} onTextSpeed={setTextSpeed} autoVoice={autoVoice} onAutoVoice={setAutoVoice} onLoadSave={applyLoadedSave}/>

      {/* Portrait + Dialogue */}
      <div style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center',padding:`0 ${px}px`,minHeight:0}}>
        
        {/* Portrait: only show when Cain is in this scene */}
        {cainHere&&hasSpoken&&!hidePortrait&&<div style={{display:'flex',justifyContent:'center',alignItems:'center',minHeight:short?140:sm?160:210,transition:'min-height .4s',
          animation:cainArriving?'cainArrive 1.6s cubic-bezier(.23,1,.32,1) both':'none'}}>
          <div style={{position:'relative'}}>
            <div style={{position:'absolute',inset:-20,borderRadius:'50%',background:`radial-gradient(circle,${sc.accent}12 0%,transparent 70%)`,animation:'breathe 4s infinite',transition:'background 1s'}}/>
            <div style={{width:portrait,height:portrait,borderRadius:'50%',overflow:'hidden',position:'relative',border:`2px solid ${sc.accent}33`,boxShadow:`0 0 40px ${sc.accent}18, inset 0 0 30px rgba(0,0,0,.4)`,transition:'all .5s'}}>
              <img src="/static/cain.jpg" alt="Cain" style={{width:'135%',height:'135%',objectFit:'cover',objectPosition:'50% 18%',position:'absolute',top:'-5%',left:'-17%',
                filter:emotion==='shy'?'saturate(1.1) brightness(1.05)':emotion==='sad'?'saturate(.75) brightness(.88)':emotion==='cold'?'saturate(.65) contrast(1.1)':'none',transition:'filter 1s'}}/></div>
            <div style={{position:'absolute',bottom:-10,left:'50%',transform:'translateX(-50%)',background:'rgba(7,6,14,.85)',backdropFilter:'blur(12px)',padding:'3px 14px',borderRadius:12,fontSize:11,letterSpacing:2,whiteSpace:'nowrap',border:`1px solid ${sc.accent}28`,color:sc.accent,fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>Cain Â· {EMOTION_MAP[emotion]||'å¹³é™'}</div>
          </div></div>}

        {/* Cain not here: atmospheric empty scene */}
        {!cainHere&&hasSpoken&&!hidePortrait&&<div style={{display:'flex',justifyContent:'center',alignItems:'center',minHeight:short?140:sm?160:210,flexDirection:'column',gap:12}}>
          <div style={{width:portrait*0.6,height:portrait*0.6,borderRadius:'50%',border:`1px dashed ${sc.accent}20`,display:'flex',alignItems:'center',justifyContent:'center',
            background:`radial-gradient(circle,${sc.accent}06 0%,transparent 70%)`}}>
            <span style={{fontSize:24,opacity:.2}}>âœ¦</span></div>
          <div style={{textAlign:'center',color:'#6a6080',fontSize:12,letterSpacing:1,lineHeight:1.8,fontFamily:"'Cormorant Garamond','Noto Serif SC',serif"}}>
            <div style={{opacity:.5}}>æœˆå…‰ç½…éš™çš„ä¸»äººéšåŒ¿äº†ä»–çš„èº«å½±</div>
            <div style={{opacity:.3,fontSize:11,marginTop:4}}>ä¹Ÿè®¸å«ä»–çš„åå­—ï¼Œä»–ä¼šå¾ªå£°è€Œæ¥â€¦â€¦</div></div>
        </div>}

        {/* Dialogue */}
        <div style={{marginTop:hasSpoken&&!hidePortrait?18:0,background:'rgba(12,11,20,.65)',backdropFilter:'blur(24px)',borderRadius:18,border:`1px solid ${sc.accent}18`,padding:sm?'14px 16px':'18px 22px',minHeight:short?80:100,position:'relative',flex:hidePortrait||!hasSpoken?1:'none',overflow:'auto',boxShadow:'inset 0 1px 0 rgba(255,255,255,.04), 0 8px 32px rgba(0,0,0,.3)'}}>
          <div style={{position:'absolute',top:8,left:12,fontSize:8,opacity:.15,color:sc.accent}}>âœ¦</div>
          <div style={{position:'absolute',bottom:8,right:12,fontSize:8,opacity:.15,color:sc.accent}}>âœ¦</div>

          {hidePortrait&&hasSpoken&&cainHere&&<div style={{width:30,height:30,borderRadius:'50%',overflow:'hidden',border:`1px solid ${sc.accent}33`,float:'left',marginRight:10,marginTop:2}}>
            <img src="/static/cain.jpg" alt="" style={{width:'135%',height:'135%',objectFit:'cover',objectPosition:'50% 18%',position:'relative',top:'-5%',left:'-17%'}}/></div>}

          {error&&!loading&&msgs.length===0&&<div style={{color:'#ff7070',fontSize:12,textAlign:'center',padding:12}}>âš  {error}</div>}
          {loading&&<div style={{fontSize:fs,lineHeight:2,color:'#9088a0',fontStyle:'italic'}}><span style={{opacity:.5}}>Cain æ­£åœ¨æ€è€ƒ</span><span className="loading-dots" style={{opacity:.5}}/></div>}
          
          {!loading&&latestReply&&cainHere&&<div onClick={!tw.done?tw.skip:undefined} style={{cursor:!tw.done?'pointer':'default'}}>
            <div style={{fontSize:fs,lineHeight:2,color:'#e4daf0',letterSpacing:.3}}>
              {tw.display.split(/([ï¼ˆ(][^ï¼‰)]+[ï¼‰)]|\*[^*]+\*)/).map((part,i)=>/^[ï¼ˆ(*]/.test(part)?<span key={i} style={{color:sc.accent+'cc',fontStyle:'italic',fontSize:fs-1}}>{part.replace(/^\*|\*$/g,'')}</span>:<span key={i}>{part}</span>)}
              {!tw.done&&<span className="cursor"/>}</div>
            {tw.done&&<div className="fade-in" style={{display:'flex',gap:8,marginTop:10,justifyContent:'flex-end',alignItems:'center'}}>
              {voiceState==='playing'&&<><span style={{fontSize:10,opacity:.5}}>ğŸ”Š æ’­æ”¾ä¸­</span><button onClick={stopTTS} style={{background:'rgba(255,255,255,.05)',border:`1px solid ${sc.accent}33`,borderRadius:12,padding:'4px 10px',fontSize:11,color:sc.accent,cursor:'pointer',fontFamily:'inherit'}}>â¹</button></>}
              {voiceState==='loading'&&<span style={{fontSize:10,opacity:.5}}>â³ è¯­éŸ³åŠ è½½ä¸­â€¦</span>}
              {voiceState==='idle'&&!autoVoice&&<button onClick={()=>{const last=msgs.filter(m=>m.role==='ai').pop();if(last)playTTS(last.text)}} style={{background:'rgba(255,255,255,.05)',border:`1px solid ${sc.accent}33`,borderRadius:12,padding:'4px 10px',fontSize:11,color:sc.accent,cursor:'pointer',fontFamily:'inherit'}}>ğŸ”Š æ’­æ”¾</button>}
            </div>}</div>}

          {!loading&&!latestReply&&!hasSpoken&&ready&&cainHere&&<div style={{fontSize:fs,lineHeight:2.2,color:'#7a7090',textAlign:'center',padding:'20px 0'}}>
            <div style={{fontSize:16,marginBottom:8,animation:'float 3s infinite',color:sc.accent+'88'}}>âœ¦</div>
            <div style={{fontFamily:"'Cormorant Garamond','Noto Serif SC',serif",fontSize:14,letterSpacing:1}}>æœˆå…‰å¦‚æ°´ï¼Œç½…éš™çš„ä¸»äººæ­£æœ›å‘ä½ â€¦â€¦</div>
            <div style={{fontSize:11,opacity:.5,marginTop:6}}>è¯•ç€å’Œ Cain è¯´äº›ä»€ä¹ˆå§</div></div>}
          {!loading&&!cainHere&&hasSpoken&&<div style={{fontSize:fs,lineHeight:2.2,color:'#5a5070',textAlign:'center',padding:'30px 0',fontStyle:'italic'}}>
            <div style={{fontSize:14,opacity:.4,fontFamily:"'Cormorant Garamond','Noto Serif SC',serif",letterSpacing:1}}>ç©ºæ°”ä¸­æ®‹ç•™ç€ä»–çš„æ°”æ¯â€”â€”è–„è·ä¸æœˆå…‰çš„å‘³é“â€¦â€¦</div></div>}
          {!ready&&!error&&<div style={{fontSize:fs,color:'#7a7090',textAlign:'center'}}>æ­£åœ¨è¿æ¥<span className="loading-dots"/></div>}
        </div></div>

      {/* Input */}
      <div style={{padding:`8px ${px}px 10px`,paddingBottom:`calc(10px + env(safe-area-inset-bottom))`}}>
        <div style={{display:'flex',gap:8,alignItems:'center',background:'rgba(12,11,20,.55)',backdropFilter:'blur(18px)',borderRadius:22,border:`1px solid ${inputFocused?sc.accent+'40':'rgba(255,255,255,.06)'}`,padding:'6px 6px 6px 18px',transition:'all .3s',boxShadow:inputFocused?`0 0 20px ${sc.accent}10`:'none'}}>
          <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}}
            onFocus={()=>setInputFocused(true)} onBlur={()=>setInputFocused(false)} placeholder={!cainHere?'å«ä»–çš„åå­—ï¼Œä¹Ÿè®¸ä»–ä¼šå¾ªå£°è€Œæ¥â€¦â€¦':loading?'Cain æ­£åœ¨å›åº”â€¦':'å¯¹ Cain è¯´ç‚¹ä»€ä¹ˆâ€¦'} disabled={loading||!ready}
            style={{flex:1,background:'transparent',border:'none',outline:'none',color:'#e8e0f0',fontSize:fs,fontFamily:'inherit',lineHeight:1.4}}/>
          <button onClick={send} disabled={loading||!input.trim()||!ready} style={{width:40,height:40,borderRadius:16,border:'none',
            background:input.trim()&&!loading?`linear-gradient(135deg,${sc.accent},${sc.accent}88)`:'rgba(255,255,255,.04)',color:input.trim()&&!loading?'#fff':'#444',fontSize:16,
            cursor:input.trim()&&!loading?'pointer':'default',display:'flex',alignItems:'center',justifyContent:'center',transition:'all .3s',flexShrink:0,
            boxShadow:input.trim()&&!loading?`0 4px 16px ${sc.accent}33`:'none'}}>â¤</button></div></div>
    </div></div>}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
